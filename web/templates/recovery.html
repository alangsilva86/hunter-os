{% extends "base.html" %}
{% block content %}
  <section class="hero">
    <div>
      <h1>Recovery</h1>
      <p>Reprocess previously downloaded Casa dos Dados exports without new API calls.</p>
    </div>
    <div class="hero-chip">SQLite mode</div>
  </section>

  {% if message %}
    <div class="notice">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="notice error">{{ error }}</div>
  {% endif %}

  <section class="card">
    <h2>Start recovery</h2>
    <form class="form" method="post" action="/recovery/start">
      <div class="form-grid">
        <label>
          arquivo_uuid
          <input id="recovery-uuid" name="arquivo_uuid" placeholder="UUID" />
        </label>
        <label>
          Enrich top %
          <input name="enrich_top_pct" type="number" value="{{ defaults.enrich_top_pct }}" min="5" max="100" />
        </label>
        <label>
          Provider
          <input name="provider" value="{{ defaults.provider }}" />
        </label>
        <label>
          Concurrency
          <input name="concurrency" type="number" value="{{ defaults.concurrency }}" min="1" max="20" />
        </label>
        <label>
          Timeout (s)
          <input name="timeout" type="number" value="{{ defaults.timeout }}" min="2" max="15" />
        </label>
        <label>
          Cache TTL (hours)
          <input name="cache_ttl_hours" type="number" value="{{ defaults.cache_ttl_hours }}" min="1" max="168" />
        </label>
        <label>
          Phone repeat threshold
          <input name="telefone_repeat_threshold" type="number" value="{{ defaults.telefone_repeat_threshold }}" min="2" max="20" />
        </label>
      </div>
      <div class="switch-row">
        <label class="switch">
          <input type="checkbox" name="excluir_mei" checked />
          <span>Exclude MEI</span>
        </label>
        <label class="switch">
          <input type="checkbox" name="enable_enrichment" checked />
          <span>Enable enrichment</span>
        </label>
      </div>
      <button class="primary" type="submit">Start recovery</button>
    </form>
  </section>

  <section class="card">
    <h2>Available export files</h2>
    {% if files %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>UUID</th>
              <th>Path</th>
              <th>Size</th>
              <th>Downloaded</th>
              <th>Use</th>
            </tr>
          </thead>
          <tbody>
            {% for row in files %}
            <tr>
              <td class="mono">{{ row.arquivo_uuid }}</td>
              <td class="mono">{{ row.file_path }}</td>
              <td>{{ row.file_size }}</td>
              <td>{{ row.downloaded_at }}</td>
              <td>
                <button
                  type="button"
                  class="ghost"
                  data-fill-target="#recovery-uuid"
                  data-fill-value="{{ row.arquivo_uuid }}"
                >
                  Use UUID
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>No export files found. Use the Exports page to download first.</p>
    {% endif %}
  </section>
{% endblock %}
